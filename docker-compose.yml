services:
  # ---------------------------------------------------------------------------
  # REVERSE PROXY (Nginx Proxy Manager)
  # ---------------------------------------------------------------------------
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '81:81' # Admin Interface
      - '443:443'
    volumes:
      - ./data/npm/data:/data
      - ./data/npm/letsencrypt:/etc/letsencrypt
    networks:
      - wow-network

  # ---------------------------------------------------------------------------
  # DASHBOARD FRONTEND (React)
  # ---------------------------------------------------------------------------
  frontend:
    build: 
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
    container_name: wow-dashboard-frontend
    restart: unless-stopped
    networks:
      - wow-network
    depends_on:
      - backend

  # ---------------------------------------------------------------------------
  # DASHBOARD BACKEND (Rust)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./server-rust
      dockerfile: Dockerfile
    container_name: wow-dashboard-backend
    restart: unless-stopped
    environment:
      - RUST_LOG=info
      - PORT=3000
      - MONGODB_URI=mongodb://mongo:27017/wow-dashboard
      - JWT_SECRET=${JWT_SECRET:-change_this_secret_in_prod}
      # Google Auth ID from .env
      - GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
      # MySQL Connection Info (Using root to ensure access to all DBs)
      - DB_USER=root
      - DB_PASS=password
      - DB_HOST=ac-database
      - DB_AUTH=acore_auth
      - DB_CHAR=acore_characters
    networks:
      - wow-network
    depends_on:
      - mongo
      - ac-database

  # ---------------------------------------------------------------------------
  # DATABASES
  # ---------------------------------------------------------------------------
  mongo:
    image: mongo:4.4.18
    container_name: wow-mongo
    restart: unless-stopped
    volumes:
      - ./data/mongo:/data/db
    networks:
      - wow-network

  # AzerothCore Database
  ac-database:
    image: mysql:8.0
    container_name: ac-database
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_USER=acore
      - MYSQL_PASSWORD=acore
      - MYSQL_DATABASE=acore_world
    volumes:
      - ./data/mysql:/var/lib/mysql
    networks:
      - wow-network
    command: --default-authentication-plugin=mysql_native_password

  # ---------------------------------------------------------------------------
  # AZEROTHCORE WOW SERVER
  # ---------------------------------------------------------------------------
  ac-worldserver:
    image: acore/ac-wotlk-worldserver:master
    container_name: ac-worldserver
    restart: unless-stopped
    stdin_open: true
    tty: true
    depends_on:
      - ac-database
      - ac-authserver
    environment:
      - AC_WORLD_DATABASE_INFO=ac-database;3306;root;password;acore_world
      - AC_CHARACTER_DATABASE_INFO=ac-database;3306;root;password;acore_characters
      - AC_LOGIN_DATABASE_INFO=ac-database;3306;root;password;acore_auth
    volumes:
      - ./data/azerothcore/etc:/azerothcore/env/dist/etc
      - ./data/azerothcore/data:/azerothcore/env/dist/data
    networks:
      - wow-network
    ports:
      - "8085:8085"

  ac-authserver:
    image: acore/ac-wotlk-authserver:master
    container_name: ac-authserver
    restart: unless-stopped
    depends_on:
      - ac-database
    environment:
      - AC_LOGIN_DATABASE_INFO=ac-database;3306;root;password;acore_auth
    volumes:
      - ./data/azerothcore/etc:/azerothcore/env/dist/etc
    networks:
      - wow-network
    ports:
      - "3724:3724"

  # Importador de Banco de Dados (Necess√°rio para o primeiro setup)
  ac-db-import:
    image: acore/ac-wotlk-db-import:master
    container_name: ac-db-import
    restart: no
    environment:
      - AC_LOGIN_DATABASE_INFO=ac-database;3306;root;password;acore_auth
      - AC_WORLD_DATABASE_INFO=ac-database;3306;root;password;acore_world
      - AC_CHARACTER_DATABASE_INFO=ac-database;3306;root;password;acore_characters
    depends_on:
      - ac-database
    networks:
      - wow-network

networks:
  wow-network:
    driver: bridge
